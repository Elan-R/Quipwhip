<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quipwhip — Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1026; --panel:#15183a; --ink:#eef1ff; --muted:#a7b2ff; --accent:#7cf; --ok:#81f5a5; --warn:#ffd166; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1000px 700px at -10% 0%, #2843a7 0%, transparent 50%),
               radial-gradient(900px 800px at 110% 30%, #5d2899 0%, transparent 45%), var(--bg);
      color:var(--ink); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
      display:grid; grid-template-rows:auto 1fr; gap:10px; padding:14px;
    }
    header{display:flex; align-items:center; justify-content:space-between}
    .brand{font-weight:700}
    .card{background:linear-gradient(180deg, #1a1d3d, #121531); border:1px solid #2b2f61; border-radius:18px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,.3)}
    input, button, textarea{
      width:100%; background:#0f1234; color:var(--ink); border:1px solid #2c3064; border-radius:14px; padding:11px 12px; font-size:16px;
    }
    button{background:linear-gradient(180deg,#3640a2,#2b327c); border-color:#4f58c9; cursor:pointer; transition:.15s}
    button:active{transform:translateY(1px)}
    .muted{color:#a9b4df}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace}
    .big{font-size:1.2rem}
    .timer{font-variant-numeric:tabular-nums; background:#0d1030; border:1px solid #363c86; padding:6px 10px; border-radius:10px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    textarea{min-height:90px; resize:vertical}
    .opt{display:block; background:#121538; border:1px solid #333a86; border-radius:14px; padding:10px 12px; margin:10px 0; text-align:left}
    .opt[disabled]{opacity:.6}
    .ok{background:linear-gradient(180deg,#2c8d4f,#1c6b39); border-color:#36a65e}
    .ghost{background:#161a43}
    .warn{background:linear-gradient(180deg,#8d6a2c,#6b4f1a); border-color:#a67c2d}
    .error{background:linear-gradient(180deg,#8d2d2d,#6b1d1d); border-color:#aa3b3b}
  </style>
</head>
<body>
  <header>
    <div class="brand">📱 Quipwhip <span class="muted">· Player</span></div>
    <div class="timer" id="phaseTimer">—</div>
  </header>

  <main class="card" id="panel">
    <!-- Filled by JS -->
  </main>

  <script type="module">
    import { JillBagPlayer } from 'https://elan-r.github.io/JillBag/jillBag.js';

    const MSG = {
      JOIN:"join", LOBBY:"lobby", START:"start", PROMPT:"prompt", ANSWER:"answer",
      REVEAL:"reveal", VOTE:"vote", RESULTS:"results", SCORE:"score", PHASE:"phase", END:"end"
    };

    const $ = sel => document.querySelector(sel);
    const panel = $("#panel");
    const timerEl = $("#phaseTimer");
    const now = () => Date.now();

    class QuipwhipPlayer extends JillBagPlayer {
      constructor(hostId) {
        super(hostId);
        this.name = "";
        this.endsAt = null;
        this.scores = {};
        this._tock = null;
        this._pendingJoin = false;   // <- set true after pressing Join
        this._lastError = "";
      }

      /* ---------- JillBag hooks ---------- */
      handlePeerReady(myId) {
        super.handlePeerReady(myId);
        // If URL already includes ?host=CODE and ?name=Foo, auto-fill
        const p = new URL(location.href).searchParams;
        const preHost = p.get("host");
        const preName = p.get("name");
        this.renderJoin(preHost || "", preName || "");
        // If a host code was passed at construction, we might already be trying to connect.
      }

      handleOpen() {
        super.handleOpen();
        // Connection to host successfully opened -> send JOIN if we have/expect a name
        if (this._pendingJoin && this.name) {
          this._sendJoinNow();
          this.renderInfo("Connected! Waiting for lobby…");
        }
      }

      handleClose() {
        super.handleClose();
        // Connection closed; if user pressed Join earlier, try reconnecting briefly
        if (this._pendingJoin) {
          this.renderWarn("Disconnected. Reconnecting…");
          setTimeout(()=> this._connectToHost(), 600);
        } else {
          this.renderWarn("Disconnected from host.");
        }
      }

      handleError(err) {
        super.handleError(err);
        this._lastError = (err && (err.message || err.toString())) || "Unknown error";
        this.renderError("Connection error: " + this._lastError);
      }

      handleData(data) {
        switch (data.type) {
          case MSG.LOBBY:
            this.renderLobby(data.players, data.hostId);
            break;
          case MSG.START:
            this.renderInfo("Game starting…");
            break;
          case MSG.PROMPT:
            this.startPhaseTimer(data.endsAt);
            this.renderPrompt(data);
            break;
          case MSG.REVEAL:
            this.startPhaseTimer(data.endsAt);
            this.renderVote(data);
            break;
          case MSG.RESULTS:
            this.renderResults(data);
            break;
          case MSG.SCORE:
            this.scores = data.scores || {};
            break;
          case MSG.PHASE:
            this.startPhaseTimer(data.endsAt || null);
            break;
          case MSG.END:
            this.renderFinal(data.scores || this.scores);
            break;
          default: break;
        }
      }

      /* ---------- UI ---------- */
      renderJoin(prefillHost="", prefillName="") {
        panel.innerHTML = "";
        const form = document.createElement("div");
        form.innerHTML = `
          <div class="muted">Join a room</div>
          <div style="margin-top:6px" class="row">
            <input id="hostCode" placeholder="Host code (e.g., ABC123)" />
            <input id="name" placeholder="Your name" maxlength="16"/>
          </div>
          <div style="margin-top:10px" class="row">
            <button id="joinBtn" class="ok">Join</button>
            <button id="randBtn" class="ghost">Random Name</button>
          </div>
          <div class="muted" style="margin-top:10px">If you opened a link from the host, the host code may already be filled in.</div>
        `;
        panel.append(form);
        $("#hostCode").value = prefillHost;
        $("#name").value = prefillName;

        $("#randBtn").addEventListener("click", ()=>{
          $("#name").value = this.randomFunName();
        });

        $("#joinBtn").addEventListener("click", ()=>{
          const code = ($("#hostCode").value || "").trim().toUpperCase();
          const nm = ($("#name").value || "Player").trim();
          if (!code) { alert("Enter the host code"); return; }
          this.name = nm.slice(0,16);

          // IMPORTANT: reconnect to the *new* hostId
          this._pendingJoin = true;
          this.closeHost();            // close any old connection attempt
          this.hostId = code;          // set new host code
          this._connectToHost();       // actively attempt to connect

          this.renderInfo("Connecting to host…");
        });
      }

      renderLobby(players) {
        panel.innerHTML = "";
        const title = document.createElement("div");
        title.className="big";
        title.textContent = "Lobby";
        const you = document.createElement("div");
        you.className="muted";
        you.textContent = `You: ${this.name}`;
        const list = document.createElement("div");
        for (const p of players) {
          const line = document.createElement("div");
          line.textContent = `${p.connected?"🟢":"🔘"} ${p.name}`;
          list.append(line);
        }
        panel.append(title, you, list);
      }

      renderInfo(msg="…") {
        panel.innerHTML = `<div class="big">${msg}</div>`;
      }
      renderWarn(msg) {
        panel.innerHTML = `<div class="big">${msg}</div>`;
      }
      renderError(msg) {
        panel.innerHTML = `<div class="big">${msg}</div><div class="muted" style="margin-top:6px">Tip: Double-check the room code and that the host page is open.</div>`;
      }

      renderPrompt({ id, text }) {
        panel.innerHTML = "";
        const q = document.createElement("div");
        q.innerHTML = `
          <div class="muted">Prompt</div>
          <div class="big" style="margin:.2rem 0 1rem 0">${text}</div>
          <textarea id="answer" maxlength="120" placeholder="Type your quip (max 120 chars)…"></textarea>
          <div class="row" style="margin-top:10px">
            <button id="submit" class="ok">Submit</button>
            <button id="clear" class="ghost">Clear</button>
          </div>
          <div class="muted" style="margin-top:6px">Don't overthink it—funny wins.</div>
        `;
        panel.append(q);
        $("#clear").addEventListener("click", ()=> { $("#answer").value=""; $("#answer").focus(); });
        $("#submit").addEventListener("click", ()=>{
          const txt = ($("#answer").value || "").trim();
          if (!txt) { alert("Write something!"); return; }
          const ok = this.sendHost({ type: MSG.ANSWER, id, text: txt });
          if (!ok) {
            this.renderError("Failed to send answer. Reconnecting…");
            this._connectToHost();
            return;
          }
          $("#answer").disabled = true;
          $("#submit").disabled = true;
          this.renderInfo("Answer submitted! Waiting for others…");
        });
      }

      renderVote({ id, options }) {
        panel.innerHTML = "";
        const v = document.createElement("div");
        v.innerHTML = `<div class="muted">Pick your favorite</div>`;
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "opt";
          btn.textContent = opt.text;
          btn.addEventListener("click", ()=>{
            const ok = this.sendHost({ type: MSG.VOTE, id, aid: opt.aid });
            for (const b of v.querySelectorAll(".opt")) b.disabled = true;
            const done = document.createElement("div");
            done.className="muted";
            done.textContent = ok ? "Vote submitted!" : "Vote failed — retrying…";
            v.append(done);
            if (!ok) setTimeout(()=> this.sendHost({ type: MSG.VOTE, id, aid: opt.aid }), 400);
          });
          v.append(btn);
        });
        panel.append(v);
      }

      renderResults({ tally, winnerAids }) {
        panel.innerHTML = "";
        const box = document.createElement("div");
        box.innerHTML = `<div class="big">Results</div>`;
        const list = document.createElement("div");
        for (const [aid, count] of Object.entries(tally).sort((a,b)=>b[1]-a[1])) {
          const row = document.createElement("div");
          row.textContent = `${count} vote${count===1?"":"s"} ${winnerAids.includes(aid)?"— 🏆":""}`;
          list.append(row);
        }
        box.append(list);
        if (this.scores && Object.keys(this.scores).length) {
          const top = Object.entries(this.scores).sort((a,b)=>b[1]-a[1]).slice(0,3);
          const sc = document.createElement("div");
          sc.className="muted";
          sc.textContent = `Leaders: ${top.map(([_,pts],i)=>`${i+1}. ${pts} pts`).join("  ")}`;
          box.append(sc);
        }
        panel.append(box);
      }

      renderFinal(scores) {
        panel.innerHTML = "";
        const title = document.createElement("div");
        title.className="big";
        title.textContent = "🎉 Final Standings";
        const list = document.createElement("div");
        const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
        sorted.forEach(([id,pts],i)=>{
          const row = document.createElement("div");
          row.textContent = `${i===0?"🥇":i===1?"🥈":i===2?"🥉":"—"}  ${pts} pts`;
          list.append(row);
        });
        const again = document.createElement("button");
        again.className="ghost"; again.textContent="Stay in room for next game";
        again.addEventListener("click", ()=> this.renderInfo("Waiting for a new game…"));
        panel.append(title, list, again);
      }

      startPhaseTimer(endsAt) {
        this.endsAt = endsAt || null;
        clearInterval(this._tock);
        if (!endsAt) { timerEl.textContent = "—"; return; }
        const tick = () => {
          const ms = Math.max(0, (this.endsAt||0) - now());
          timerEl.textContent = `${Math.ceil(ms/1000)}s`;
          if (ms <= 0) clearInterval(this._tock);
        };
        tick();
        this._tock = setInterval(tick, 250);
      }

      /* ---------- Helpers ---------- */
      _sendJoinNow() {
        const payload = { type: MSG.JOIN, name: this.name };
        this.sendHost(payload); // If it returns false, host isn't open yet; handleOpen will try again after reconnect
      }

      randomFunName() {
        const A = ["Spicy","Wobbly","Sneaky","Quantum","Soggy","Turbo","Judge","Captain","Dr.","Major","Baby","Mega","Sir","Lady"];
        const B = ["Pickle","Frog","Banana","Giraffe","Noodle","Lobster","Potato","Muffin","Taco","Walrus","Ferret","Goblin","Tiger"];
        return `${A[Math.floor(Math.random()*A.length)]} ${B[Math.floor(Math.random()*B.length)]}`;
      }
    }

    // Boot player
    const params = new URL(location.href).searchParams;
    const paramHost = params.get("host") || "";
    const player = new QuipwhipPlayer(paramHost);
  </script>
</body>
</html>
